class Player:
    def __init__(self, race):
        self.x = 0
        self.y = 0
        self.level = 1

        # Setup character's race.
        self.race = race
        self.max_health = self.health = self.race.first_level['max_health']
        self.strength = self.race.first_level['strength']
        self.attack = self.race.first_level['inventory'][0].attack
        self.inventory = self.race.first_level['inventory'][0]
        self.speed = self.race.speed

    def learn(self, monster):
        self.attack += math.floor(monster.attack/4)
        self.strength += math.floor(monster.attack/4)
        self.level_up()

    def level_up(self):
        s = math.floor(self.strength/20)
        if s >= 1 and s <= 8:
            self.level = s
            self.max_health = self.level*self.race.level_up_bonus

    def attack_monster(self, monster):
        if monster.speed < self.speed:
            self.health -= monster.attack
            if self.health > 0:
                monster.health -= self.attack
        elif monster.speed >= self.speed:
            monster.health -= self.attack
            if monster.health > 0:
                self.health -= monster.attack
                
        if self.health > 0: self.learn(monster)
        return (self.health <= 0, monster.health <= 0)
        
    def add_inventory_item(self, item):
        self.inventory.append(item)
        self.inventory.sort(key = lambda x: x.weight)
        self.speed = 4 + max(0, self.inventory[0].weight-self.strength)
        if isinstance(item, Weapon):
            self.attack = item.attack

    def move(self, event, GS):
        if self.health < self.max_health:
            self.health += 1
            
        dX, dY = consts.GAME_KEYS['M'][event.keychar.upper()]
        nX = self.x + dX
        nY = self.y + dY
        if nX >= consts.WIDTH and GS['terrain_map'].more_dungeons():
            GS['messages'].insert(0, "You move on through the forest")
            (self.x, self.y) = terrain_map.generate_new_map() 
        if GS['terrain_map'].is_walkable(nX, nY):
            self.x = nX
            self.y = nY
            if (nX, nY) in GS['terrain_map'].water:
                GS['messages'].insert(0, "You slosh through the cold water.")
        else:
            GS['messages'].insert(0, "You hit a tree")

        m = GS['terrain_map'].monster_at(nX, nY)
        if m:
            (self_dead, monster_dead) = self.attack_monster(m)
            GS['messages'].insert(0, "You attack the "+type(m).__name__)
            if not monster_dead:
                GS['messages'].insert(0, "The "+type(m).__name__+" attacks you")
                GS['messages'].insert(0, "It's health is now "+str(m.health))
            else:
                GS['messages'].insert(0, "You vanquish the "+type(m).__name__)
                GS['terrain_map'].proweling_monsters.remove(m)
            if self_dead:
                GS['messages'].insert(0, "You have died.")
                GS['screen'] = 'DEATH'
            

